name: Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for security vulnerabilities
      run: npm audit --audit-level=moderate

    - name: Run linter
      run: npm run lint
      continue-on-error: true

    - name: Check file structure
      run: |
        echo "Checking required files..."
        test -f package.json
        test -f server.js
        test -f Procfile
        test -f app.json
        test -f public/index.html
        test -f public/config.js
        test -f public/agentforce-api.js
        test -f public/chat-widget.js
        test -f public/styles.css
        echo "All required files present!"

    - name: Validate package.json
      run: |
        node -e "const pkg = require('./package.json'); 
        if (!pkg.engines || !pkg.engines.node) throw new Error('Missing node engine in package.json');
        if (!pkg.dependencies || !pkg.dependencies.express) throw new Error('Missing express dependency');
        console.log('package.json is valid!');"

    - name: Check environment template
      run: |
        if [ ! -f ENV_TEMPLATE.txt ]; then
          echo "ENV_TEMPLATE.txt is missing!"
          exit 1
        fi
        echo "ENV_TEMPLATE.txt exists!"

    - name: Validate Heroku configuration
      run: |
        node -e "const config = require('./app.json');
        const required = ['SALESFORCE_INSTANCE_URL', 'SALESFORCE_CLIENT_ID', 'SALESFORCE_CLIENT_SECRET', 'SALESFORCE_AGENT_ID'];
        const envVars = Object.keys(config.env || {});
        required.forEach(v => {
          if (!envVars.includes(v)) throw new Error('Missing required env var in app.json: ' + v);
        });
        console.log('app.json is valid!');"

    - name: Test server starts (mock environment)
      run: |
        export SALESFORCE_INSTANCE_URL="https://test.salesforce.com"
        export SALESFORCE_CLIENT_ID="test_client_id"
        export SALESFORCE_CLIENT_SECRET="test_client_secret"
        export SALESFORCE_AGENT_ID="0XxTest000000000"
        export PORT=3000
        timeout 10 node server.js || true
        echo "Server test completed!"

    - name: Summary
      run: |
        echo "âœ… Validation completed successfully!"
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"

